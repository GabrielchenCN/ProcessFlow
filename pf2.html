<!doctype html>
<html>

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.12.2/d3.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
    <style>
    svg {
        display: block;
    }
    </style>
</head>

<body>
    <style type="">
        .diamond{ transform: rotate(45deg); transform-origin: 50% 50%;translate(-50%,-50%); }
    </style>
    <svg width="1000" height="1000">
        <defs>
            <marker id="markerArrow" markerWidth="13" markerHeight="13" refX="14" refY="6" orient="auto">
                <path d="M2,2 L2,11 L10,6 L2,2" />
            </marker>
        </defs>
        <g></g>
    </svg>
    <script>
    const rw = 30,
        rh = 30;
    var nodes = [{
        "id": 1,
        "text": "start",
        "ip": "1.1.1.1",
        "r": 20,
        "x": 50,
        "y": 100,
        "type": "circle"
    }, {
        "id": 2,
        "text": "query task",
        "ip": "1.1.1.2",
        "r": 30,
        "x": 200,
        "y": 100,
        "rw": rw,
        "rh": rh,
        "type": "rect"
    }, {
        "id": 3,
        "text": "judge-1",
        "ip": "1.1.1.3",
        "r": 15,
        "x": 350,
        "y": 100,
        "rw": rw,
        "rh": rh,
        "type": "diamond"
    }, {
        "id": 4,
        "text": "update process status:error",
        "ip": "1.1.1.4",
        "r": 20,
        "x": 350,
        "y": 150,
        "rw": rw,
        "rh": rh,
        "type": "rect"
    }, {
        "id": 5,
        "text": "merge to parent",
        "ip": "1.1.1.4",
        "r": 20,
        "x": 500,
        "y": 100,
        "rw": rw,
        "rh": rh,
        "type": "rect"
    }, {
        "id": 6,
        "text": "repository save",
        "ip": "1.1.1.4",
        "r": 20,
        "x": 650,
        "y": 100,
        "rw": rw,
        "rh": rh,
        "type": "rect"
    }, {
        "id": 7,
        "text": "update process status:success",
        "ip": "1.1.1.4",
        "r": 20,
        "x": 650,
        "y": 150,
        "type": "circle"
    }, {
        "id": 8,
        "text": "End",
        "ip": "1.1.1.4",
        "r": 20,
        "x": 650,
        "y": 200,
        "type": "circle"
    }];
    var links = [{
        "source": 1,
        "target": 2
    }, {
        "source": 2,
        "target": 3
    }, {
        "source": 3,
        "target": 4
    }, {
        "source": 3,
        "target": 5
    }, {
        "source": 4,
        "target": 8,
        "polyLine": true
    }, {
        "source": 5,
        "target": 6
    }, {
        "source": 6,
        "target": 7
    }, {
        "source": 7,
        "target": 8
    }];

    // 数据转换
    links.some(function(v, i) {
        nodes.some(function(w, j) {
            if (v.source == w.id) {
                v.source = w;
            }
            if (v.target == w.id) {
                v.target = w;
            }
        });
        v.index = ++i;
    });
    console.log(nodes);
    console.log(links);
    // console.info(d3.select("body").select("svg"));



    var svg = d3.select("body").select("svg");
    var links = svg.selectAll("path")
        .data(links)
        .enter().append("path")
        .style("fill", "none")
        .attr("class", "link")
        .attr("d", function(d) {
            if (d.polyLine) {
                // var x1 = d.source.x;
                //   var y1 = d.source.y;
                //   var x2 = d.target.x;
                //   var y2 = d.target.y;

                //   return "M" + x1 + "," + y1 + "L" + x1 + "," + y2+ "L" + x2 + "," + y2 + "L" + x2;

                return d3.line()
                    .x(function(d) { return d.x })
                    .y(function(d) { return d.y })
                    .curve(d3.curveStepBefore)([d.source, d.target])
            } else {

                var x1 = d.source.x;
                var y1 = d.source.y;
                var x2 = d.target.x;
                var y2 = d.target.y;

                return "M" + x1 + " " + y1 + "L" + x2 + " " + y2;
            }
        })
        .style("stroke", "blue")
        .style("storke-width", "1px");

    var nodes = svg.selectAll(".node")
        .data(nodes)
        .enter()
        .append("g")
        .attr("class", "node-group");


    nodes
        .filter(function(d) { return d.type === "circle"; })
        .append("circle")
        .attr("class", "node")
        .attr("r", function(d) {
            return d.r
        })
        .attr("cx", function(d) {
            return d.x;
        })
        .attr("cy", function(d) {
            return d.y;
        })
        .style("fill", "red")
        .on("click", function(d,i){
           alert("This is " +d.text)
        });

    var g = nodes
        .filter(function(d) { return d.type === "diamond"; })
        .append("rect")
        .attr("class", "node diamond")
        .attr("x", function(d, i) { return d.x; })
        .attr("y", function(d, i) { return d.y; })
        .attr("width", function(d, i) { return d.rw; })
        .attr("height", function(d, i) { return d.rh; })
        .style("fill", "blue")
        .attr("transform", "translate(-15,-15) rotate(45 50% 50%)")
        .on("click", function(d,i){
            alert("This is " +d.text)
        });

    nodes
        .filter(function(d) { return d.type === "rect"; })
        .append("rect")
        .attr("class", "node")
        .attr("x", function(d, i) { return d.x; })
        .attr("y", function(d, i) { return d.y; })
        .attr("width", function(d, i) { return d.rw; })
        .attr("height", function(d, i) { return d.rh; })
        .attr("transform", function(d, i) { return "translate(-" + d.rw / 2 + ",-" + d.rh / 2 + ")"; })
        .style("fill", "red")
        .on("click", function(d,i){
             alert("This is " +d.text)
        });

    nodes.call(d3.drag()
        .on("start", dragstart)
        .on("drag", dragged)
        .on("end", dragend));

    function dragstart() {

    }

    function dragged(d) {
        d.x = d3.event.x;
        d.y = d3.event.y;

        // 重新绘制当前节点以及相关的链路位置即可
        var node = d3.select(this);
        node.attr("cx", d.x)
            .attr("cy", d.y);
        var link = links.filter(function(v, i) {
            if (v.source.id == d.id || v.target.id == d.id) {
                return true;
            }
        });
        link.attr("d", function(d) {
            if (d.polyLine) {
                // var x1 = d.source.x;
                //   var y1 = d.source.y;
                //   var x2 = d.target.x;
                //   var y2 = d.target.y;

                //   return "M" + x1 + "," + y1 + "L" + x1 + "," + y2+ "L" + x2 + "," + y2 + "L" + x2;

                return d3.line()
                    .x(function(d) { return d.x })
                    .y(function(d) { return d.y })
                    .curve(d3.curveStepBefore)([d.source, d.target])
            } else {

                var x1 = d.source.x;
                var y1 = d.source.y;
                var x2 = d.target.x;
                var y2 = d.target.y;

                return "M" + x1 + " " + y1 + "L" + x2 + " " + y2;
            }
        });
    }

    function dragend() {

    }
    </script>
</body>

</html>